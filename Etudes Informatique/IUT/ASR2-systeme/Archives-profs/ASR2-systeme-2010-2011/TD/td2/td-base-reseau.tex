\documentclass[12pt]{article}

% amélioration après TD (lancement de serveur NFS après modif exports)

\usepackage{a4wide}
\usepackage{sujets}
\usepackage{verbatim}
\usepackage{moreverb}

\quand{Semestre 2, année 2009-2010}
\siglefeuille{TP}
\siglemat{ASR2-S}
\titrefeuille{Module  ASR2 Système}
\formation{Département Informatique IUT Bordeaux 1}
\titre{Bases d'administration réseau}


\sloppy

\begin{document}
% \maketitle

\section{Objectifs de la séance}

Ce document explique quelques notions de base sur l'administration de
machines Unix en réseau. Ces notions sont montrées à travers
l'utilisation de machines virtuelles UML\footnote{User Mode Linux}
sous distribution Debian 3.1.




Pendant cette séance vous apprendrez à 
\begin{itemize}
\item faire communiquer des machines par le réseau
\item partager des fichiers entre machines.
\end{itemize}





\section{Configuration d'un réseau de deux machines}



Nous allons constituer un réseau de deux machines.

Choisissez un nom pour votre réseau (par exemple \texttt{brothers.org})
et deux noms de machine (\texttt{groucho} et \texttt{harpo}).


Créez les machines virtuelles par la commande
\begin{verbatim}
uml create debian groucho harpo
\end{verbatim}



Il faut aussi décider des \emph{numéros IP\/}\footnote{
 En bref, un \emph{numéro IP} (IPv4 pour être précis) est un nombre sur 32 bits
qui sert à identifier un élément du réseau, et que l'on représente
généralement sous forme de 4 octets exprimés en décimal. Exemple
\texttt{147.210.94.200}.
Certains numéros sont réservés, d'autres sont destinés à constituer
des réseaux privés ;  c'est le
cas, en particulier des numéros qui commencent par \texttt{10.} ou
\texttt{172.16.}
 qui permettront
de les identifier.} de ces machines : 
vous utiliserez ici les numéros \texttt{10.1.1.1} et
\texttt{10.1.1.2}.








\subsection{Lancement du réseau}


La commande
% \begin{tscreen}
\begin{verbatim}
uml run  groucho harpo
\end{verbatim}
% \end{tscreen}
démarre les deux machines virtuelles, en les reliant en réseau.
Chaque machine est munie d'une carte réseau \texttt{eth0} connectée à
un commutateur (virtuel).

\paragraph{La première fois} connectez-vous sur \texttt{groucho} avec le compte \texttt{root} (sans mot de passe), et tapez les commandes
\begin{verbatim}
echo groucho > /etc/hostname
echo "127.0.0.1 groucho" >> /etc/hosts
halt
\end{verbatim}
pour configurer correctement le nom de la machine 
et l'\textbf{arrêter proprement}\footnote{N'arrêtez jamais une machine virtuelle en fermant sa fenêtre qui y est associé : le processus qui est derrière continue à tourner...}. Idem sur l'autre machine.

Redémarrez-les, et constatez que les noms ont bien été pris en compte.

\subsection{Configuration manuelle}



Sur une des machines, faire \texttt{ifconfig eth0 10.1.1.1} (et
l'équivalent sur l'autre).\footnote{\texttt{ifconfig} = InterFace
  CONFIGuration}

Vérifiez que les deux machines communiquent, avec la commande
\texttt{ping}\emph{adresse\/}.



Il est pénible d'utiliser des numéros. Enregistez les noms et les
adresses IP dans le fichier \texttt{/etc/hosts} de chaque machine.
Constatez qu'on peut faire \texttt{ping groucho.brothers.org} depuis
\texttt{harpo}, et inversement.

Dans le \texttt{/etc/resolv.conf}, indiquez le suffixe par défaut
\texttt{brothers.org}. Maintenant on peut faire \texttt{ping groucho}
tout court.

Déclarez un utilisateur sur les deux machines. 
\begin{verbatim}
useradd -m william
passwd william
\end{verbatim}
Vérifiez qu'il peut
passer d'une machine à l'autre par \texttt{ssh nom@machine}.



\paragraph*{Remarque} le remplissage manuel des fichiers \texttt{/etc/hosts} est
impraticable au delà de quelques machines sur le réseau. On installe
alors un \emph{server de noms\/} (Domain Name Server) qui diffuse la
liste d'adresses sur le réseau. On met l'adresse des serveurs de noms
dans \texttt{/etc/resolv.conf}.




\subsection{Configuration permanente}


Sur la distribution Debian, la configuration de l'adresse réseau est
fait par la commande \texttt{ifup eth0}, qui prend ses paramêtres dans
le fichier \texttt{/etc/network/interfaces}. Sur \texttt{groucho} vous
y trouverez les lignes
\begin{verbatim}
auto lo
iface lo inet loopback
\end{verbatim}
qui décrivent l'interface locale \texttt{lo} \footnote{qui est présente systématiquement sur chaque machine, et porte l'adresse \texttt{127.0.0.1}}.
Vous y ajouterez les lignes suivantes
\begin{verbatim}
auto eth0
iface eth0 inet static
   address 10.1.1.1
   netmask 255.255.255.0
\end{verbatim}

Redémarrez \texttt{groucho}, pour vérifier que le paramétrage 
a été conservé. Idem pour l'autre machine.




\section{Communication par talk}

Le programme \texttt{talk} est un outil de conversation en direct\footnote{on dit ``chat'' maintenant} qui remonte à la plus haute antiquité d'Unix.
\begin{enumerate}
\item installez les packages nécessaires (client et serveur), et démarrez le service sur les deux machines
\begin{verbatim}
apt-get install talkd ytalk 
killall -1 inetd
\end{verbatim}
\item 
Si le destinataire est connecté et accepte les message (\texttt{mesg y}),
vous pouvez le contacter et entamer un dialogue
\begin{verbatim}
talk destinataire@machine
\end{verbatim}
\end{enumerate}

\section{Partage de fichiers entre machines}



Pour partager des données entre deux machines on utilise le protocole NFS
(\emph{Network File System\/}). Nous allons utiliser une machine comme serveur
de fichiers, et l'autre comme client.




\subsection{Export}

Sur le serveur, 

\begin{enumerate}
\item
installez le package ``serveur NFS''
\begin{verbatim}
apt-get install nfs-kernel-server
\end{verbatim}
\item créez un répertoire \texttt{/commun} et placez-y deux
ou trois fichiers. 
\item Dans \texttt{/etc/exports}, placez la ligne
% \begin{tscreen}
\begin{verbatim}
/commun       *(rw,sync)
\end{verbatim}
% \end{tscreen}
\item relancez le serveur NFS pour qu'il prenne en compte le nouveau fichier
\texttt{/etc/exports} :
\texttt{/etc/init.d/nfs-kernel-server restart}
\item vérifiez (\texttt{showmount -e}) que le répertoire \texttt{commun} est bien exporté.
\end{enumerate}


\subsection{Montage manuel}

Sur le client, créez un répertoire vide \texttt{/import} et "montez"-y  le répertoire commun (du serveur):
% \begin{tscreen}
\begin{verbatim}
mount groucho:/commun /import
\end{verbatim}
% \end{tscreen}


Normalement, vous voyez maintenant les fichiers partagés dans 
\texttt{/import}.

\subsection{Montage permanent}

Pour que le montage soit permanent, déclarez-le dans 
\texttt{/etc/fstab} 
% \begin{tscreen}
\begin{verbatim}
groucho:/commun /import nfs  rsize=8192,wsize=8192 0 0
\end{verbatim}
% \end{tscreen}

\end{document}
